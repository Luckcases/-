<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0" />
    <meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
    <title>端API</title>
    <link rel="stylesheet" type="text/css" href="../css/api.css" />
    <link rel="stylesheet" type="text/css" href="../css/style.css" />
    <style>
        body {
            background-color: #f0f0f0;
        }
        
        .space {
            height: 10px;
        }
        
        .room_info {
            height: 60px;
            background-color: #fff;
            border-bottom: 1px #f0f0f0 solid;
        }
        
        .innerLeft {
            width: 60px;
            display: inline-block;
            height: 60px;
            border-radius: 50%;
            overflow: hidden;
            position: relative;
        }
        
        .innerLeft img {
            height: 60px;
            width: 60px;
        }
        
        .innerMid {
            position: relative;
            top: -7px;
            height: 60px;
            width: 200px;
            display: inline-block;
        }
        
        .innerMid .firstSpan {
            line-height: 35px;
            font-size: 15px;
        }
        
        .innerMid .secondSpan {
            line-height: 25px;
            font-size: 12px;
            color: rgb(150, 150, 150);
        }
        
        .search_bar {
            height: 35px;
            width: 100%;
        }
        
        .search_parent {
            position: fixed;
        }
        
        .search_btn {
            height: 35px;
            width: 35px;
            position: fixed;
            background: url('../image/search_btn.jpg');
            background-color: #f0f0f0;
            background-position: center;
            background-size: 20px 20px;
            background-repeat: no-repeat;
            background-clip: border-box;
            background-attachment: fixed;
            cursor: pointer;
            z-index: 2;
        }
        
        .search_text {
            width: 100%;
            height: 35px;
            padding-left: 35px;
            position: fixed;
            background-color: #f0f0f0;
            border-bottom: 1px solid rgba(200, 200, 200, 0.5);
            z-index: 1;
        }
        
        .cancel_btn {
            float: right;
            height: 35px;
            width: 35px;
            position: fixed;
            background: url('../image/cancel.jpg');
            background-color: #f0f0f0;
            background-position: center;
            background-size: 20px 20px;
            background-repeat: no-repeat;
            background-clip: border-box;
            background-attachment: fixed;
            cursor: pointer;
            z-index: 2;
        }
        
        .slide-btn {
            height: 23px;
            width: 72px;
            top: 17px;
            float: right;
            right: 5px;
            display: inline-block;
            border: 1px solid;
            border-color: rgba(0, 0, 0, 0.1) rgba(0, 0, 0, 0.1) rgba(0, 0, 0, 0.25);
            border-radius: 23px;
            position: relative;
            overflow: hidden;
            cursor: pointer;
        }
        
        .slide-btn .inner-on,
        .slide-btn .inner-off {
            width: 150px;
            box-sizing: border-box;
            display: inline-block;
            position: relative;
            left: -51px;
            cursor: pointer;
        }
        
        .inner-off {
            background: #f0f0f0;
            transition: left 0.5s;
        }
        
        .inner-on {
            background-color: rgba(100, 149, 237, 0.5);
            transition: left 0.5s;
        }
        
        .inner-on .space,
        .inner-off .space {
            position: relative;
            left: 51px;
            height: 23px;
            width: 23px;
            display: inline-block;
            box-sizing: border-box;
            color: #fff;
            background-color: #f5f5f5;
            border-left: 1px solid #cccccc;
            border-right: 1px solid #cccccc;
            border-radius: 23px;
            background-image: linear-gradient(to bottom, #ffffff, #e6e6e6);
            border-color: rgba(0, 0, 0, 0.1) rgba(0, 0, 0, 0.1) rgba(0, 0, 0, 0.25);
        }
    </style>
</head>

<body>
    <!-- 上部搜索条和排序 -->
    <div class="search_bar">
        <div class="search_parent">
            <input type="button" id='search_btn' class="search_btn">
            <input type="text" class="search_text" placeholder="搜索" id='search_text' onchange="searchBy()">
            <input type="text" class="sort_type" id="sort_type" readonly="readonly" onclick="sortBy()">
        </div>
    </div>
    <!-- 隐藏的排序按钮 -->
    <div class="SortArea" id="SortArea">
        <p onclick="changeSortType(0)" class="pp" id='Sort0'>按时间排序</p>
        <div class="divider"></div>
        <p onclick="changeSortType(1)" class="pp" id='Sort1'>按风险排序</p>
    </div>

    <div class="space" id='flag'></div>
    <!-- <div class="room_info">
        <div class="innerLeft">
            <img alt="" src="../image/forumPic.png">
        </div>
        <div class="innerMid" onclick="openHistory()">
            <span class="firstSpan">房间号：9532614</span>
            <span class="secondSpan">累计监控时长：10h</span>
        </div>
        <div class="slide-btn">
            <div class="inner-on" id="inner">
                <input style="display:none;" type="checkbox" checked>
                <span class="space"></span>
            </div>
        </div>
    </div> -->


</body>
<script type="text/javascript" src="../script/api.js"></script>
<script type="text/javascript" src="../script/jquery-3.3.1.js"></script>
<script type="text/javascript">
    var token = localStorage.getItem("token");
    apiready = function() {
        getHistoryInfo();
        initSort();
    }

    initSort = function() { //在页面加载时初始化与排序有关的组件
        var toleft = document.documentElement.clientWidth - 45 - 1;
        $('#sort_type').css({
            "margin-left": toleft
        });
        $api.byId('sort_type').value = '排序';
        toleft = document.documentElement.clientWidth - 100;
        $('#SortArea').css({
            "margin-left": toleft
        });
    }

    changeSortType = function(i) { //排序选项点击事件
        j = (i + 1) % 2
        $("#Sort" + i).addClass("chosen");
        $("#Sort" + j).removeClass("chosen");
    }

    sortBy = function(i) { //打开排序选项框
        $("#SortArea").slideToggle(500);
    }

    getHistoryInfo = function() {
        api.ajax({
            url: 'http://47.98.53.200:5000/danmu/history/',
            method: 'get',
            headers: {
                //'Content-Type': 'application/json;charset=utf-8',
                'authorization': 'JWT ' + token,
                // "enctype": "multipart/form-data",
                // 'Connection': 'keep-alive'
            },
            // data: {
            //     values: {
            //         'short_name': '6040761'
            //     }
            // }
        }, function(ret, err) {
            // alert(JSON.stringify(ret));
            var js = '';
            for (var i in ret.results) {
                js += createTheTab(ret.results[i].id);
            }
            $('div').remove('.room_info');
            $("#flag").after(js);
            for (var n in ret.results) {
                if (ret.results[n].is_supervising == false) {
                    changeOpen(ret.results[n].id);
                }
            }
        });
    }

    createTheTab = function(id) {
        var str = '<div class="room_info">' +
            '<div class="innerLeft">' +
            '<img src="../image/douyu.jpg">' +
            '</div>' +
            '<div class="innerMid" onclick="openHistory(' + id + ')">' +
            '<span class="firstSpan">房间号：' + id + '</span>' +
            '<span class="secondSpan">累计监控时长：10h</span>' +
            '</div>' +
            '<div class="slide-btn">' +
            '<div class="inner-on" id = "' + id + '" onclick = "changeOpen(' + id + ')">' +
            '<input style="display:none;" type="checkbox" checked>' +
            '<span class="space"></span>' +
            '</div>' +
            '</div>' +
            '</div>';
        return str;
    }

    searchBy = function() {
        //修改按钮格式
        $("#search_btn").attr({
            "onclick": "cancelSearch()",
            "class": "cancel_btn",
            "type": "button",
            "id": 'search_btn'
        });

        //关闭旧请求进行新的http请求
        api.cancelAjax({
            tag: 'search'
        });
        var roomId = $api.byId('search_text').value;
        api.ajax({
            url: 'http://47.98.53.200:5000/search/rooms/',
            method: 'post',
            tag: 'search',
            headers: {
                'Content-Type': 'application/json;charset=utf-8',
                'authorization': 'JWT ' + token,
                "enctype": "multipart/form-data",
                // 'Connection': 'keep-alive'
            },
            data: {
                body: {
                    'roomId': roomId,
                    'query': 'danmu'
                }
            }
        }, function(ret, err) {
            var js = '';
            for (var i in ret.results) {
                js += createTheTab(ret.results[i].id);
            }
            $('div').remove('.room_info');
            $("#flag").after(js);
            for (var n in ret.results) {
                if (ret.results[n].is_supervising == false) {
                    changeOpen(ret.results[n].id);
                }
            }
            if (err) {
                alert(JSON.stringify(err));
            }
        });

    }

    cancelSearch = function() {
        $("#search_btn").attr({
            "onclick": " ",
            "class": "search_btn"
        });

        $api.byId('search_text').value = '';

        getHistoryInfo();

    }

    openHistory = function(id) {
        localStorage.setItem('Rid', id);
        api.openWin({
            name: 'detailHistory',
            url: 'detailHistory.html',
            pageParam: {
                name: 'test'
            }
        });

    }


    changeOpen = function(id) {
        var Item = document.getElementById(id);
        if (Item.className == "inner-on") {
            // if (Item.attr("class") == "inner-on") {
            Item.style.left = 0 + "px";
            Item.childNodes[1].checked = false;
            Item.className = "inner-off";
            // Item.addClass('inner-off');
        } else {
            Item.style.left = -51 + "px";
            Item.childNodes[1].checked = true;
            Item.className = "inner-on";
        }
    }
</script>

</html>