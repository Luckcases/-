<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0" />
    <meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
    <title>云API</title>
    <link rel="stylesheet" type="text/css" href="../css/api.css" />
    <link rel="stylesheet" type="text/css" href="../css/style.css" />
    <style>
        body {
            background-color: #f0f0f0;
        }
        /*搜索模块*/

        .content {
            min-height: calc(100vh - 190px);
        }

        .search_bar {
            height: 35px;
            width: 100%;
        }

        .search_parent {
            position: fixed;
        }

        .search_btn {
            height: 35px;
            width: 35px;
            position: fixed;
            background: url('../image/search_btn.jpg');
            background-color: #f0f0f0;
            background-position: center;
            background-size: 20px 20px;
            background-repeat: no-repeat;
            background-clip: border-box;
            background-attachment: fixed;
            cursor: pointer;
            z-index: 102;
        }

        .cancel_btn {
            float: right;
            height: 35px;
            width: 35px;
            position: fixed;
            background: url('../image/cancel.jpg');
            background-color: #f0f0f0;
            background-position: center;
            background-size: 35px 35px;
            background-repeat: no-repeat;
            background-clip: border-box;
            background-attachment: fixed;
            cursor: pointer;
            z-index: 102;
        }

        .search_text {
            width: 100%;
            height: 35px;
            padding-left: 35px;
            position: fixed;
            background-color: #f0f0f0;
            border-bottom: 1px solid rgba(220, 220, 220, 0.3);
            z-index: 101;
        }
        /*排序模块，位于搜索模块右侧*/

        .sort_type {
            width: 45px;
            height: 35px;
            position: fixed;
            color: rgb(150, 150, 150);
            text-align: center;
            border-left: 1px solid rgba(220, 220, 220, 0.3);
            z-index: 102;
        }
        /*上部信息显示和折线图容器*/

        .topContent {
            margin-top: 50px;
            height: 300px;
            width: 100%;
            background: #fff;
        }
        /*折线图容器*/

        .cavContainer {
            height: 250px;
        }
        /*下部简略信息按钮*/

        .topUnderOp {
            border-top: 1px #dddddd solid;
            height: 45px;
            overflow: hidden
        }

        .topUnderOp span {
            line-height: 45px;
        }

        .OpLeft {
            float: left;
        }

        .OpRight {
            float: right;
        }
        /*房间信息标签*/

        .slide-box {
            margin-top: 10px;
            display: -webkit-box;
            overflow-x: scroll;
            -webkit-overflow-scrolling: touch;
            height: 170px;
        }

        .slide-item {
            width: 200px;
            height: 150px;
            border: 1px solid #ccc;
            margin-top: 10px;
            margin-right: 30px;
            background-image: url('../image/douyu.jpg');
            background-position: center;
            background-size: 200px 150px;
            background-repeat: no-repeat;
            background-clip: border-box;
            background-attachment: fixed;
        }

        .bottomContent {
            height: 25px;
            margin-top: 125px;
            background: #000;
            opacity: 0.5;
        }

        .bottomContent span {
            color: #fff;
            line-height: 25px;
            height: 25px;
        }
        /*移动按钮*/

        .info-nr {
            position: fixed;
            height: 40px;
            width: 40px;
            background: url('../image/add_icon.jpg') no-repeat fixed center;
            border: 1px #fff solid;
            border-radius: 40px;
        }
        /*排序选择按钮容器*/

        .SortArea {
            display: none;
            width: 100px;
            height: 75px;
            position: fixed;
            background-color: #f0f0f0;
            z-index: 102;
            border-top: 1px solid #dddddd;
        }

        .SortArea .pp {
            width: 100%;
            height: 37px;
            line-height: 37px;
            text-align: center;
        }

        .chosen {
            background-color: #dddddd;
        }
    </style>
</head>

<body>
    <div class="content">
        <!-- 上部搜索条和排序 -->
        <div class="search_bar" id="">
            <div class="search_parent">
                <input type="button" id='search_btn' class="search_btn">
                <input type="text" class="search_text" placeholder="搜索" id='search_text' onchange="searchBy()">
                <input type="text" class="sort_type" id="sort_type" readonly="readonly" onclick="sortBy()">
            </div>
        </div>

        <!-- 隐藏的管理按钮 -->
        <div class="SortArea" id="SortArea">
            <p onclick="Manage(0)" class="pp" id='Sort0'>添加</p>
            <p onclick="Manage(1)" class="pp" id='Sort1'>删除</p>
        </div>

        <!-- 房间信息展示列表项 -->

        <div class="topContent">
            <div class="cavContainer" id='cavContainer'>
            </div>
            <div class="topUnderOp" onclick="openDetail()">
                <span class="OpLeft" id='OpLeft'>近期积极比例：57%</span><span class="OpRight">点击查看详情</span>
            </div>
        </div>

    </div>

    <div class="slide-box">
        <div id='flag'></div>
        <div class="slide-item" onclick="changeShow(156235)">
            <div class="bottomContent">
                <span>房间号156235<span>
          </div>
        </div>
        <div class="slide-item"></div>
        <div class="slide-item"></div>
        <div class="slide-item"></div>
        <div class="slide-item"></div>
    </div>


</body>


<script type="text/javascript" src="../script/jquery-3.3.1.js"></script>
<script type="text/javascript" src="../script/highcharts.js"></script>
<script type="text/javascript" src="../script/charts.js"></script>
<script type="text/javascript" src="../script/api.js"></script>
<script type="text/javascript">
    var token = localStorage.getItem('token');
    var xmlhttp = new XMLHttpRequest();
    var Rid;
    apiready = function() {
        initSort();
        initSlide();
    }

    initSort = function() { //在页面加载时初始化与排序有关的组件
        var toleft = document.documentElement.clientWidth - 45 - 1;
        $('#sort_type').css({
            "margin-left": toleft
        });
        $api.byId('sort_type').value = '管理';
        toleft = document.documentElement.clientWidth - 100;
        $('#SortArea').css({
            "margin-left": toleft
        });
    }

    initSlide = function(){
      api.ajax({ //请求信息
          url: 'http://47.98.53.200:5000/danmu/analyse/',
          method: 'get',
          headers: {
              //'Content-Type': 'application/json;charset=utf-8',
              'authorization': 'JWT ' + token,
              //"enctype": "multipart/form-data",
              // 'Connection': 'keep-alive'
          },

      }, function(ret, err) {
          if (err) {
              alert(JSON.stringify(err));
          } else {
            alert(JSON.stringify(ret));
            if (ret.count != 0){
              initList(ret);
            }
          }
      });
    }

    changeShow = function(id){
      Rid = id;
      dynPic(id);
    }

    Manage = function(i) { //管理选项点击事件
        var j = (i + 1) % 2;
        $("#Sort" + i).addClass("chosen");
        $("#Sort" + j).removeClass("chosen");
        if (i == 0){
          openAddPage();
        }else{

        }
    }

    sortBy = function(i) { //打开排序选项框
        $("#SortArea").slideToggle(500);
    }

    initList = function(ret) { //根据服务器返回数据建立列表
        var addStr = '';
        changeShow(ret.results[0].id);
        for (var i in ret.results) {
            addStr +=
                '<div class="slide-item" id = "' + ret.results[i].id + '" onclick="changeShow(' + ret.results[i].id + ')">'+
                  '<div class="bottomContent">'+
                    '<span>房间号' + ret.results[i].id + '<span>'+
                  '</div>'+
                '</div>'
        }
        $('div').remove(".slide-item")
        $("#flag").after(addStr);
        for (var i in ret.results) {
          if (ret.results[i].img != null){
            $('#' + ret.results[i].id).css({
              "background-image": "url('../image/douyu.jpg')"
            });
          }
        }
    }

    searchBy = function() { //搜索响应事件
        //修改按钮格式
        $("#search_btn").attr({
            "onclick": "cancelSearch()",
            "class": "cancel_btn",
            "type": "button",
            "id": 'search_btn'
        });

        //关闭旧请求进行新的http请求
        api.cancelAjax({
            tag: 'search'
        });
        var roomId = $api.byId('search_text').value;
        api.ajax({
            url: 'http://47.98.53.200:5000/search/rooms/',
            method: 'post',
            tag: 'search',
            headers: {
                'Content-Type': 'application/json;charset=utf-8',
                'authorization': 'JWT ' + token,
                "enctype": "multipart/form-data",
                // 'Connection': 'keep-alive'
            },
            data: {
                body: {
                    'roomId': roomId,
                    'query': 'rooms'
                }
            }
        }, function(ret, err) {
            initList(ret);
            if (err) {
                alert(JSON.stringify(err));
            }
        });

    }

    cancelSearch = function() { //取消搜索
        $("#search_btn").attr({
            "onclick": " ",
            "class": "search_btn"
        });

        $api.byId('search_text').value = '';

        apiready();
    }

    openDetail = function() {
        localStorage.setItem('Rid', Rid);
        api.openWin({
            name: 'detailPage',
            url: 'detailPage.html',
            pageParam: {
                name: 'test'
            }
        });
    }

    openAddPage = function() {
        api.openWin({
            name: 'addNew',
            url: './addNew.html',
            pageParam: {
                name: 'test'
            }
        });
    }

    requstforLong = function(chart) { //请求长连接
        var result = [];
        var xmlhttp = new XMLHttpRequest();
        xmlhttp.open("POST", "http://47.98.53.200:5000/danmu/analyse/", true);
        xmlhttp.setRequestHeader('Content-Type', 'application/json;charset=utf-8', 'authorization', 'JWT ' + token, 'enctype', 'multipart/form-data'); //设置头部
        var json = {};
        json.roomId = Rid;
        xmlhttp.onreadystatechange = function(e) { //接受请求的函数，服务器每返回一次数据都会响应
            if (xmlhttp.readyState == 2) {
                console.log('已收到服务器响应的标头');
            } else if (xmlhttp.readyState == 3) {
                result = xmlhttp.responseText.split(','); //将服务器返回的字符串变为数组
                chart.addPoint([(new Date()).getTime(), parseInt(result[result.length - 2])], true, true);
                console.log(result);
            } else if (xmlhttp.readyState == 4 && xmlhttp.status == 200) {
                console.log('服务器响应完毕!!');
                console.log(xmlhttp.responseText);
            }
        };
        xmlhttp.send(JSON.stringify(json)); //发送请求
    }

    dynPic = function(id) { //生成动态折线图
        var chart = {
            type: 'spline',
            animation: Highcharts.svg, // don't animate in IE < IE 10.
            marginRight: 10,
            events: {
              load: function() {
                  var series = this.series[0];
                  requstforLong(series);
              }
            }
        };
        var title = {
            text: ''
        };
        var xAxis = {
            type: 'datetime',
            tickPixelInterval: 150
        };
        var yAxis = {
            title: {
                text: '积极度'
            },
            plotLines: [{
                value: 0,
                width: 1,
                color: '#808080'
            }]
        };
        var tooltip = {
            formatter: function() {
                return '<b>' + this.series.name + '</b><br/>' +
                    Highcharts.dateFormat('%Y-%m-%d %H:%M:%S', this.x) + '<br/>' +
                    Highcharts.numberFormat(this.y, 2);
            }
        };
        var plotOptions = {
            area: {
                pointStart: 1940,
                marker: {
                    enabled: false,
                    symbol: 'circle',
                    radius: 2,
                    states: {
                        hover: {
                            enabled: true
                        }
                    }
                }
            }
        };
        var legend = {
            enabled: false
        };
        var exporting = {
            enabled: false
        };
        var credits = {
            enabled: false //右下角的版权信息不显示
        };
        var series = [{
            name: 'Random data',
            data: (function() {
                // generate an array of random data
                var data = [],
                    time = (new Date()).getTime(),
                    i;
                for (i = -99; i <= 0; i += 1) {
                    data.push({
                        x: time + i * 1000,
                        y: Math.random()
                    });
                }
                return data;
            }())
        }];

        var json = {};
        json.chart = chart;
        json.tooltip = tooltip;
        json.xAxis = xAxis;
        json.yAxis = yAxis;
        json.legend = legend;
        json.exporting = exporting;
        json.series = series;
        json.plotOptions = plotOptions;
        json.credits = credits;
        json.title = title;


        Highcharts.setOptions({
            global: {
                useUTC: false
            }
        });
        $('#cavContainer').highcharts(json);

    }

    addInitEvent = function(){
      window.addEventListener('touchstart', function(event) {
        var touch = event.targetTouches[0];
        // 把元素放在手指所在的位置
        touchStart = touch.pageY;
        console.log(touchStart);
    }, false);
    window.addEventListener('touchmove', function(event) {
        var touch = event.targetTouches[0];
        console.log(touch.pageY + 'px');
        scroll.style.top = scroll.offsetTop + touch.pageY-touchStart + 'px';
        console.log(scroll.style.top);
        touchStart = touch.pageY;
        touchDis = touch.pageY-touchStart;
    }, false);
    window.addEventListener('touchend', function(event) {
        touchStart = 0;
        var top = scroll.offsetTop;
        console.log(top);
        if(top>70)apiready();
        if(top>0){
            var time = setInterval(function(){
                scroll.style.top = scroll.offsetTop -2+'px';
                if(scroll.offsetTop<=0)clearInterval(time);
            },1)
        }
    }, false);
  }
    //倒序函数
    Turn = function(arr) {
        var temp = [];
        for (var i in arr) {
            temp[i] = arr[arr.length - i - 1];
        }
        return temp;
    }
</script>

</html>
